---
title: "R Notebook"
#output: html_notebook

output:
  md_document:
    variant: markdown_github
    toc: true
    toc_depth: 3
---

# Downloading Data from the internet
Use `download.file()` that takes the url and the destination on your computer to save the file at. And note that

* If the file url starts with **http** you can use `download.file()`.
* It is also okay to use `download.file()` in case of **https** and **windows**.
* But on **Mac**, you might need to set `method="curl"` to download from **https** url.
* The download duration depends on the file size.

Example: download the 2006 microdata survey about housing for the state of Idaho.
```{r}
url <- "https://d396qusza40orc.cloudfront.net/getdata%2Fdata%2Fss06hid.csv"
download.file(url, "house_data.csv") ##save in the current dir, and name the file "data.csv"
```

List the files in the current directory
```{r}
list.files("./")
```

Use `date()` to get the downloading date.
```{r}
downloadDate <- date()
downloadDate
```

# Reading Excel Files
First download the file using `download.file()`
```{r}
url <- "https://d396qusza40orc.cloudfront.net/getdata%2Fdata%2FDATA.gov_NGAP.xlsx"
download.file(url, "data.xlsx",mode="wb")
date()
```

## Using `xlsx` Package

You can read the file using `read.xlsx` or `read.xlsx2`. You will need to download the `xlsx` package to use them.
```{r}
# Load the library
library(rJava)
library(xlsxjars)
library(xlsx)
readFile <- read.xlsx("data.xlsx", sheetIndex=1)
head(readFile)
```
 
You might face some difficulities when using the xlsx library. Here is the most famous error:
 
Error : .onLoad failed in loadNamespace() for 'rJava', details:
  call: inDL(x, as.logical(local), as.logical(now), ...)

  error: unable to load shared object 'C:/Users/me/Documents/R/win-library/2.13/rJava/libs/x64/rJava.dll':
  LoadLibrary failure:  %1 is not a valid Win32 application.

Error: package/namespace load failed for 'rJava'

**To solve that you will need to :**

* download the `rJava` package (if the error remains)
* check your R version `R.version()`, and download the corresponding java (32/64), from [here](https://www.java.com/en/download/win10.jsp).
* Finally, check if your Java is in `Program Files` or `Program Files (x86)`. Add the path to the **jvm.dll** to your PATH in **windows Environment**. If the java file is in `Program Files (x86)`, it means you have 32-bit version, and you can change the default version of your `Rstudio` from Tools >> Global options to 32 bit. For more information check [this](http://stackoverflow.com/questions/7019912/using-the-rjava-package-on-win7-64-bit-with-r).

### Reading specific rows and columns form the Excel file
```{r}
c <- 7:15
r <- 18:23
readSubset <- read.xlsx("data.xlsx", sheetIndex=1, colIndex = c, rowIndex = r)
readSubset
```

## Using `readxl` Package
Another way to read Excel files is to use `read_excel` from the `readxl` library. For more information check [this](http://stackoverflow.com/questions/7049272/importing-xlsx-file-into-r).

After installing the package..
```{r}
library(readxl)
dataFile <- read_excel("data.xlsx")
head(dataFile)
```

# Reading XML Files
XML stands for *"Extensible Markup Language"*. For more information see [wiki_xml](https://en.wikipedia.org/wiki/XML#Key_terminology) and [readXML](https://www.stat.berkeley.edu/~statcur/Workshop2/Presentations/XML.pdf). We start by downloading and loading the `XML` package. Then reading the xml file with `xmlTreeParse`.
```{r}
library(XML)

url <- "https://www.w3schools.com/xml/simple.xml"
download.file(url, "simple.xml")

xmlFile <- xmlTreeParse("simple.xml", useInternalNodes = TRUE)
## check the file class 
class(xmlFile)
```

Wrapping the content inside the xml file. 
```{r}
## get the content of the root
rootNode <- xmlRoot(xmlFile)
rootNode
```

**Now, start exploring**
```{r}
## Get the name of the node
xmlName(rootNode)

## Take a look at the content of the first child
rootNode[[1]]

## How many children in the node (number of food nodes)
xmlSize(rootNode)

## Get the name of the first child node
xmlName(rootNode[[1]])
```
**We can also list the names and the sizes of the subnodes**
```{r}
## number of childrens inside the first child 
xmlSize(rootNode[[1]])

## Get the names of the childrens inside the first child 
xmlSApply(rootNode[[1]], xmlName)

## Extract the food "name" from all subnodes
xmlSApply(rootNode, function(x) x[[1]][[1]])

## Another way to get inside values, price in this case 
xmlSApply(rootNode, function(x) x[['price']][[1]])
```

## Using `XPath`
`xpathApply` and `xpathSApply` provide a way to find XML nodes that match a particular criterion to identify nodes of interest within the document. The set of matching node are returned as a list. For more information type `?xpathApply` in R console. Note that `xpathSApply` is a simplified version of `xpathApply`, just like `Sapply` and `apply`.

** XPath Language Notes **

* `/node` - Top level node
* `//node` - Node at ANY level
* `node[@attr-name]` - node that has an attribute named "attr-name"
* `node[@attr-name='bob']` - node that has attribute named attr-name with value 'bob'
* `node/@x` - value of attribute x in node with such attr.

```{r}
## Get the food "name"
xpathApply(rootNode, "//name", xmlValue)

## Get the food "name" with xpathSApply
xpathSApply(rootNode, "//name", xmlValue)

## Get the prices
xpathApply(rootNode, "//price", xmlValue)

## Get the prices with xpathSApply
xpathSApply(rootNode, "//price", xmlValue)
```

** Extract content by attributes **
First, we load another xml `books.xml` file that contains attributes to work on. You can find it [here](https://msdn.microsoft.com/en-us/library/ms762271(v=vs.85).aspx) or in the file directory [here](https://github.com/FA78DWA/Reading-Data-Tutorial-R).

```{r}
## Load the file, and wrap into one variable
books <- xmlRoot(xmlTreeParse("books.xml", useInternalNodes = TRUE))

## Show the the first book from the books library we loaded
books[[1]]

## Get the number of books inside the library
xmlSize(books)

## Get the title of the "book"s that have "id" attribute. In this case all books have "id"
xpathSApply(books, "//book[@id]/title", xmlValue)

## Get the "title" of the book with "id = bk103". Note that "id" is an "attribute"
xpathSApply(books, "//book[@id='bk103']/title", xmlValue)
```

